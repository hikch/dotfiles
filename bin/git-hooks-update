#!/bin/sh
# Update existing Git repositories with global hooks
# Usage: git-hooks-update [directories...]
# Example: git-hooks-update ~/dev ~/projects

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default directories to search if none provided
DEFAULT_DIRS="$HOME/dev $HOME/projects $HOME/workspace"

# Parse arguments
if [ $# -eq 0 ]; then
    echo "${BLUE}No directories specified. Using defaults:${NC}"
    SEARCH_DIRS=""
    for dir in $DEFAULT_DIRS; do
        if [ -d "$dir" ]; then
            SEARCH_DIRS="$SEARCH_DIRS $dir"
            echo "  - $dir"
        fi
    done

    if [ -z "$SEARCH_DIRS" ]; then
        echo "${YELLOW}No default directories found. Please specify directories:${NC}"
        echo "  git-hooks-update ~/dev ~/projects"
        exit 1
    fi
else
    SEARCH_DIRS="$*"
fi

echo ""
echo "${BLUE}Searching for Git repositories...${NC}"

# Find all Git repositories
REPOS=""
for search_dir in $SEARCH_DIRS; do
    if [ ! -d "$search_dir" ]; then
        echo "${YELLOW}Warning: Directory not found: $search_dir${NC}"
        continue
    fi

    # Find .git directories (excluding nested .git in subdirectories of repos)
    found_repos=$(find "$search_dir" -type d -name .git -prune 2>/dev/null | sed 's|/.git$||')

    if [ -n "$found_repos" ]; then
        REPOS="$REPOS
$found_repos"
    fi
done

# Remove leading newline and count repos
REPOS=$(echo "$REPOS" | sed '/^$/d')
REPO_COUNT=$(echo "$REPOS" | wc -l | tr -d ' ')

if [ -z "$REPOS" ] || [ "$REPO_COUNT" -eq 0 ]; then
    echo "${YELLOW}No Git repositories found in specified directories.${NC}"
    exit 0
fi

echo "${GREEN}Found $REPO_COUNT repositories${NC}"
echo ""

# Confirm before proceeding
echo "${YELLOW}This will run 'git init' in each repository to apply global hooks.${NC}"
echo "${YELLOW}Existing hooks will NOT be overwritten.${NC}"
printf "${YELLOW}Continue? [y/N] ${NC}"

# Read from /dev/tty to handle piped input
read -r response < /dev/tty || response="n"

case "$response" in
    [yY][eE][sS]|[yY])
        echo ""
        ;;
    *)
        echo "${RED}Aborted.${NC}"
        exit 0
        ;;
esac

# Update each repository
SUCCESS_COUNT=0
FAIL_COUNT=0
SKIPPED_COUNT=0

echo "${BLUE}Updating repositories...${NC}"
echo ""

echo "$REPOS" | while IFS= read -r repo; do
    if [ -z "$repo" ]; then
        continue
    fi

    printf "  %-60s " "$repo"

    # Check if directory exists
    if [ ! -d "$repo" ]; then
        echo "${RED}[SKIP: Not found]${NC}"
        SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        continue
    fi

    # Check if it's a valid git repository
    if [ ! -d "$repo/.git" ]; then
        echo "${RED}[SKIP: Not a Git repo]${NC}"
        SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        continue
    fi

    # Run git init to apply template
    if (cd "$repo" && git init >/dev/null 2>&1); then
        # Check if hook was actually installed
        if [ -f "$repo/.git/hooks/pre-commit" ]; then
            echo "${GREEN}[OK]${NC}"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        else
            echo "${YELLOW}[WARN: Hook not created]${NC}"
            FAIL_COUNT=$((FAIL_COUNT + 1))
        fi
    else
        echo "${RED}[FAIL]${NC}"
        FAIL_COUNT=$((FAIL_COUNT + 1))
    fi
done

# Summary
echo ""
echo "${BLUE}========================================${NC}"
echo "${BLUE}Update Summary${NC}"
echo "${BLUE}========================================${NC}"
echo "${GREEN}Success: $SUCCESS_COUNT${NC}"
if [ $FAIL_COUNT -gt 0 ]; then
    echo "${RED}Failed:  $FAIL_COUNT${NC}"
fi
if [ $SKIPPED_COUNT -gt 0 ]; then
    echo "${YELLOW}Skipped: $SKIPPED_COUNT${NC}"
fi
echo ""

# Verify init.templateDir is configured
TEMPLATE_DIR=$(git config --global init.templateDir || echo "")
if [ -z "$TEMPLATE_DIR" ]; then
    echo "${YELLOW}WARNING: init.templateDir is not configured globally.${NC}"
    echo "${YELLOW}Run: git config --global init.templateDir ~/.config/git/template${NC}"
    echo ""
elif [ "$TEMPLATE_DIR" != "$HOME/.config/git/template" ] && \
     [ "$TEMPLATE_DIR" != "~/.config/git/template" ]; then
    echo "${YELLOW}WARNING: init.templateDir points to different location:${NC}"
    echo "${YELLOW}  Current: $TEMPLATE_DIR${NC}"
    echo "${YELLOW}  Expected: ~/.config/git/template${NC}"
    echo ""
fi

if [ $FAIL_COUNT -eq 0 ] && [ $SKIPPED_COUNT -eq 0 ]; then
    echo "${GREEN}All repositories updated successfully!${NC}"
else
    echo "${YELLOW}Some repositories could not be updated. Please review the output above.${NC}"
fi
